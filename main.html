<!DOCTYPE html>
<style>

body{
	font-family:arial;
	
	background:rgb(235,235,235);
}

.canvas{
	position:fixed;
	top:0px;
	left:0px;
	right:0px;
	bottom:0px;
}
.canvas canvas{
	width:100%;
	height:100%;
}

</style>
<html>
<head>
<meta charset="utf-8"/>

<title>Device.js | Development</title>

<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="minimum-scale=1.0, width=device-width, maximum-scale=1, user-scalable=no" name="viewport"/>

<link rel="stylesheet" href="/resources/css/resets.css"/>

<script src='/resources/scripts/classie.js'></script>

<script src='/resources/scripts/Post.js'></script>
<script src='/resources/scripts/Device.js'></script>
<script src='/_ah/channel/jsapi'></script>

</head>
<body>


<div class='canvas'><canvas id='canvas'></canvas></div>


<script type='text/javascript'>
(function(){
	
	/*
	
	Device.register('Mobile Device');// auto assign ID... use nick name
	device.connect('120cch8934');
	device.addEventListener('onmessage', OnReceive);
	device.send(data);
	device.device('120cch8934').send()
	device.devices()
	
	*/
	
	window.addEventListener('load', Init);

P1 = [{"time":1424627856631,"mag":18.906746481806284},{"time":1424627856686,"mag":18.906746481806284},{"time":1424627856732,"mag":18.906746481806284},{"time":1424627856784,"mag":18.906746481806284},{"time":1424627856836,"mag":18.906746481806284},{"time":1424627856886,"mag":18.906746481806284},{"time":1424627856935,"mag":18.906746481806284},{"time":1424627856984,"mag":18.906746481806284},{"time":1424627857034,"mag":18.906746481806284},{"time":1424627857083,"mag":18.906746481806284},{"time":1424627857135,"mag":18.906746481806284},{"time":1424627857181,"mag":18.906746481806284},{"time":1424627857231,"mag":18.988627444034385},{"time":1424627857281,"mag":18.590065182163563},{"time":1424627857333,"mag":19.30348975196844},{"time":1424627857383,"mag":19.125783802243575},{"time":1424627857435,"mag":19.17760067856079},{"time":1424627857486,"mag":19.17966627129266},{"time":1424627857534,"mag":19.211683975067388},{"time":1424627857582,"mag":19.164534869498716},{"time":1424627857635,"mag":19.164534869498716},{"time":1424627857681,"mag":19.38210563105458},{"time":1424627857732,"mag":19.282749018447486},{"time":1424627857783,"mag":19.357078312103447},{"time":1424627857835,"mag":19.72880536790163},{"time":1424627857883,"mag":18.775205526559493},{"time":1424627857932,"mag":18.547970389854804},{"time":1424627857986,"mag":19.252823865826592},{"time":1424627858036,"mag":18.18163334486495},{"time":1424627858081,"mag":20.450890056340103},{"time":1424627858133,"mag":17.788718282823524},{"time":1424627858185,"mag":17.380758290311306},{"time":1424627858233,"mag":22.173297253942014},{"time":1424627858282,"mag":16.16944505327913},{"time":1424627858336,"mag":15.612989056255511},{"time":1424627858385,"mag":16.015568355193196},{"time":1424627858431,"mag":16.015568355193196},{"time":1424627858485,"mag":17.353173210679472},{"time":1424627858535,"mag":14.687075856315772},{"time":1424627858585,"mag":14.687075856315772},{"time":1424627858634,"mag":14.93538065432746},{"time":1424627858683,"mag":14.287331348614305},{"time":1424627858733,"mag":14.586462778697653},{"time":1424627858783,"mag":13.990011781789613},{"time":1424627858833,"mag":14.499230817791185},{"time":1424627858884,"mag":15.525887876610023},{"time":1424627858931,"mag":13.145819322082499},{"time":1424627858986,"mag":14.344782494946129},{"time":1424627859036,"mag":13.557377845372452},{"time":1424627859085,"mag":13.805993744138235},{"time":1424627859136,"mag":13.472582781276051},{"time":1424627859181,"mag":16.60696254869396},{"time":1424627859233,"mag":22.378895298447492},{"time":1424627859285,"mag":13.514997107634578},{"time":1424627859333,"mag":11.48609949001837},{"time":1424627859385,"mag":11.48609949001837},{"time":1424627859433,"mag":15.60451633415839},{"time":1424627859483,"mag":10.535606915506323},{"time":1424627859531,"mag":30.007508043724176},{"time":1424627859583,"mag":28.64138166352875},{"time":1424627859635,"mag":14.369193031390806},{"time":1424627859682,"mag":10.490687613343459},{"time":1424627859733,"mag":15.858293321503357},{"time":1424627859785,"mag":11.71920221491253},{"time":1424627859836,"mag":19.615554089550052},{"time":1424627859886,"mag":27.238841514401795},{"time":1424627859932,"mag":23.599963675634417},{"time":1424627859984,"mag":11.730222684745009},{"time":1424627860036,"mag":12.694498220579836},{"time":1424627860086,"mag":11.185076944552744},{"time":1424627860136,"mag":14.512245632775278},{"time":1424627860185,"mag":20.691982634286894},{"time":1424627860233,"mag":25.205659156688977},{"time":1424627860283,"mag":14.554215815217157},{"time":1424627860335,"mag":14.554215815217157},{"time":1424627860383,"mag":11.556743151141697},{"time":1424627860434,"mag":12.345910959866263},{"time":1424627860481,"mag":11.739911941897848},{"time":1424627860531,"mag":15.573016439037442},{"time":1424627860586,"mag":24.423169337351798},{"time":1424627860631,"mag":18.20383633183004},{"time":1424627860683,"mag":13.279301884401484},{"time":1424627860735,"mag":13.258700109468373},{"time":1424627860786,"mag":13.262594859583718},{"time":1424627860832,"mag":14.409530307885406},{"time":1424627860886,"mag":15.01187096948633},{"time":1424627860936,"mag":14.238930090407951},{"time":1424627860981,"mag":14.645455338703181},{"time":1424627861032,"mag":13.661025332096834},{"time":1424627861085,"mag":13.919492654993643},{"time":1424627861132,"mag":13.919492654993643},{"time":1424627861184,"mag":14.66219302085282},{"time":1424627861231,"mag":16.96349749974301},{"time":1424627861282,"mag":21.483911745728555},{"time":1424627861334,"mag":29.575178766925916},{"time":1424627861387,"mag":13.745756636109261},{"time":1424627861436,"mag":16.313241883323187},{"time":1424627861486,"mag":18.06299429543708},{"time":1424627861534,"mag":17.409486921354254},{"time":1424627861586,"mag":16.48298163194494},{"time":1424627861636,"mag":22.03623613724337},{"time":1424627861687,"mag":18.672778422590877},{"time":1424627861737,"mag":20.343608254591878},{"time":1424627861786,"mag":19.93222845116839},{"time":1424627861835,"mag":18.361210963236967},{"time":1424627861884,"mag":19.109277781928608},{"time":1424627861936,"mag":19.57400496487149},{"time":1424627861982,"mag":19.357543659339964},{"time":1424627862033,"mag":19.459951190709145},{"time":1424627862082,"mag":19.459951190709145},{"time":1424627862133,"mag":19.285303290869198},{"time":1424627862185,"mag":19.6705734076666},{"time":1424627862233,"mag":19.313111809812437},{"time":1424627862284,"mag":18.51880729255647},{"time":1424627862332,"mag":19.076545404270576},{"time":1424627862382,"mag":20.18446896970904},{"time":1424627862433,"mag":19.11396096320434},{"time":1424627862483,"mag":19.161516033319078},{"time":1424627862535,"mag":19.564171802875638},{"time":1424627862582,"mag":19.357724611486248},{"time":1424627862634,"mag":19.287650177261103},{"time":1424627862683,"mag":18.948167307868008},{"time":1424627862739,"mag":19.27520130655366},{"time":1424627862784,"mag":19.86347610160506},{"time":1424627862833,"mag":19.433859512244105},{"time":1424627862885,"mag":19.433859512244105},{"time":1424627862932,"mag":19.777934954231306},{"time":1424627862986,"mag":19.613756219429472},{"time":1424627863036,"mag":19.613756219429472},{"time":1424627863086,"mag":19.066267379746847},{"time":1424627863131,"mag":19.3475538703183},{"time":1424627863181,"mag":19.529957230056223},{"time":1424627863235,"mag":19.261201669823024},{"time":1424627863282,"mag":19.72997270468485},{"time":1424627863335,"mag":19.0880075105301},{"time":1424627863387,"mag":19.415871480539902},{"time":1424627863435,"mag":19.664866173902347},{"time":1424627863484,"mag":19.22860705662054}]

P2 = [{"time":1424627859475,"mag":18.634763698757734},{"time":1424627859521,"mag":18.942181946806944},{"time":1424627859572,"mag":18.588993563556095},{"time":1424627859628,"mag":19.059269814565592},{"time":1424627859671,"mag":18.743910391241144},{"time":1424627859721,"mag":18.553229861846315},{"time":1424627859771,"mag":19.223117078200133},{"time":1424627859822,"mag":18.614399396911203},{"time":1424627859872,"mag":18.973773361904566},{"time":1424627859925,"mag":18.62265047168266},{"time":1424627859973,"mag":18.632169344774326},{"time":1424627860021,"mag":18.68252419664823},{"time":1424627860071,"mag":18.83283481779124},{"time":1424627860121,"mag":18.66869351776456},{"time":1424627860176,"mag":18.759880289149685},{"time":1424627860222,"mag":18.81922113089805},{"time":1424627860272,"mag":18.91111387294422},{"time":1424627860321,"mag":18.764044155239596},{"time":1424627860373,"mag":18.663966710751524},{"time":1424627860421,"mag":19.092761548401036},{"time":1424627860471,"mag":19.092761548401036},{"time":1424627860522,"mag":17.979792772379295},{"time":1424627860571,"mag":20.723467670391198},{"time":1424627860621,"mag":16.948331362590462},{"time":1424627860671,"mag":19.37330884237659},{"time":1424627860722,"mag":18.303950161929794},{"time":1424627860772,"mag":17.755337377233026},{"time":1424627860821,"mag":17.24081275360074},{"time":1424627860871,"mag":15.647916127577513},{"time":1424627860921,"mag":14.858460357789374},{"time":1424627860971,"mag":16.435738263013654},{"time":1424627861021,"mag":16.025507308106828},{"time":1424627861070,"mag":14.39091186518908},{"time":1424627861121,"mag":14.509449232122925},{"time":1424627861171,"mag":14.165692607520333},{"time":1424627861221,"mag":16.675522415260374},{"time":1424627861271,"mag":14.15220124256705},{"time":1424627861324,"mag":13.754897187391336},{"time":1424627861371,"mag":14.411539189728723},{"time":1424627861421,"mag":14.178535244409149},{"time":1424627861471,"mag":14.675726392249786},{"time":1424627861521,"mag":17.15421146497522},{"time":1424627861571,"mag":25.146394135006055},{"time":1424627861624,"mag":13.71462403181894},{"time":1424627861671,"mag":13.71462403181894},{"time":1424627861721,"mag":10.263672932687276},{"time":1424627861771,"mag":14.377269611337033},{"time":1424627861821,"mag":10.086700530583702},{"time":1424627861871,"mag":28.14381079630412},{"time":1424627861921,"mag":32.14638254272823},{"time":1424627861971,"mag":16.23855609289689},{"time":1424627862021,"mag":10.589483869213193},{"time":1424627862071,"mag":13.578066312510325},{"time":1424627862299,"mag":24.293973508393332},{"time":1424627862321,"mag":11.341392429173561},{"time":1424627862371,"mag":11.341392429173561},{"time":1424627862421,"mag":11.166383027195193},{"time":1424627862471,"mag":10.971417939220398},{"time":1424627862521,"mag":14.531144395402961},{"time":1424627862571,"mag":21.459567422995946},{"time":1424627862621,"mag":22.93684292252022},{"time":1424627862671,"mag":14.453712945077843},{"time":1424627862721,"mag":10.636343378942563},{"time":1424627862771,"mag":12.16967531760907},{"time":1424627862821,"mag":11.244512659235156},{"time":1424627862871,"mag":14.311894449910076},{"time":1424627862922,"mag":23.750020345188805},{"time":1424627862971,"mag":16.634050083168056},{"time":1424627863021,"mag":12.193176755216708},{"time":1424627863071,"mag":12.401989743304002},{"time":1424627863121,"mag":12.589834548932416},{"time":1424627863170,"mag":13.294267625389672},{"time":1424627863221,"mag":14.059867608029029},{"time":1424627863271,"mag":13.962372873515056},{"time":1424627863321,"mag":13.32448032169305},{"time":1424627863372,"mag":13.240720068245937},{"time":1424627863421,"mag":13.66453750661564},{"time":1424627863471,"mag":14.200867160873694},{"time":1424627863521,"mag":15.600215763705393},{"time":1424627863571,"mag":13.792692142415824},{"time":1424627863621,"mag":13.792692142415824},{"time":1424627863671,"mag":14.997076098887707},{"time":1424627863721,"mag":23.042935015082822},{"time":1424627863771,"mag":16.384815411981474},{"time":1424627863821,"mag":15.982090096503098},{"time":1424627863871,"mag":22.59937404199967},{"time":1424627863921,"mag":19.911417419265927},{"time":1424627863971,"mag":22.403298186922406},{"time":1424627864021,"mag":13.840985422367714},{"time":1424627864071,"mag":19.279309722855793},{"time":1424627864121,"mag":17.38484313833405},{"time":1424627864171,"mag":19.890487394849764},{"time":1424627864221,"mag":20.563929552526435},{"time":1424627864271,"mag":19.751354888219712},{"time":1424627864321,"mag":20.469321012096625},{"time":1424627864371,"mag":19.1473047663915},{"time":1424627864421,"mag":19.36212349845643},{"time":1424627864471,"mag":19.465801379830502},{"time":1424627864521,"mag":19.09175862550631},{"time":1424627864571,"mag":19.490453321440377},{"time":1424627864621,"mag":19.268478036259555},{"time":1424627864671,"mag":19.268478036259555},{"time":1424627864721,"mag":19.099402861112868},{"time":1424627864771,"mag":19.312861901055456},{"time":1424627864821,"mag":19.83794194517747},{"time":1424627864871,"mag":18.858513356808295},{"time":1424627864921,"mag":18.68151291361405},{"time":1424627864971,"mag":20.127821778005185},{"time":1424627865021,"mag":17.91067033705594},{"time":1424627865071,"mag":18.946304609479327},{"time":1424627865121,"mag":18.083964969301654},{"time":1424627865171,"mag":20.15579148118119},{"time":1424627865221,"mag":19.649721728146503},{"time":1424627865271,"mag":19.568004436087243},{"time":1424627865321,"mag":19.685442069250534},{"time":1424627865371,"mag":19.111925722890778},{"time":1424627865422,"mag":19.689705241902303},{"time":1424627865471,"mag":19.041637427188338},{"time":1424627865521,"mag":18.963386126010054},{"time":1424627865571,"mag":19.339862179287653},{"time":1424627865621,"mag":19.263655706687363},{"time":1424627865671,"mag":19.841113361073827},{"time":1424627865721,"mag":18.899156175241426},{"time":1424627865772,"mag":18.899156175241426},{"time":1424627865821,"mag":18.910381861682975},{"time":1424627865871,"mag":19.346828056790812},{"time":1424627865921,"mag":19.420504878092352},{"time":1424627865971,"mag":19.63138377522045},{"time":1424627866021,"mag":19.499369998663965},{"time":1424627866071,"mag":19.28290377362342},{"time":1424627866121,"mag":19.629614481163355}]

	function Init(){
		LoadCanvas();
		Graph(P2);
	}
	
	var canvas, ctx, width, height;
	
	function LoadCanvas(){
		canvas = document.getElementById('canvas');
		canvas.removeAttribute('id');
		
		ctx = canvas.getContext('2d');
		
		OnResize();
		window.addEventListener('resize', OnResize);
	}
	function OnResize(){
		height = canvas.height = canvas.offsetHeight;
		width = canvas.width = canvas.offsetWidth;
	}
	
	function MaxMin(list, getter){
		if(typeof getter != 'function') getter = function(x){return x;};
		var max = getter(list[0]), min = getter(list[0]);
		for(var i=1; i<list.length; i++){
			var value = getter(list[i]);
			if(value < min) min = value;
			if(value > max) max = value;
		}
		return {max:max, min:min};
	}
	function FindPeaks(data){
		var peaks = [];
		for(var i=0,point; point=data[i++];){
			var lastpoint = data[i-2],
					nextpoint = data[i];
			if(!lastpoint || !nextpoint) continue;
			
			// max
			if(lastpoint.mag <= point.mag && nextpoint.mag <= point.mag) peaks.push(point);
			// min
			if(lastpoint.mag >= point.mag && nextpoint.mag >= point.mag) peaks.push(point);
		}
		return peaks;
	}
	function FilterPeaks(data, threshhold){
		var peaks = [];
		for(var i=0; i<data.length; i++){
			var peak = data[i];
			var adjacents = [];
			if(!!data[i-1]) adjacents.push(data[i-1]);
			if(!!data[i+1]) adjacents.push(data[i+1]);
			
			var average_change = 0;
			for(var k=0,adj; adj=adjacents[k++];){
				average_change += Math.abs(peak.mag-adj.mag) / Math.abs(peak.time-adj.time);
			}
			average_change /= adjacents.length;
			
			// average_change is the change over time taken.
			if(isNaN(average_change) || Math.abs(average_change) < threshhold) continue;
			
			peaks.push(peak);
		}
		return peaks;
	}
	function FrequencyFrames(data, threshhold){
		var freqs = [];
		for(var start=0; start<data.length; start++){
			for(var end=start+1; end<data.length; end++){
				var freq = (end-start) / (data[end].time - data[start].time);
				if(freq > threshhold) freqs.push({start:start, end:end});
			}
		}
		return freqs;
	}
	function LargestFrame(data){
		var largest = data[0];
		for(var i=0,frame; frame=data[i++];){
			if(largest.end - largest.start < frame.end - frame.start) largest = frame;
		}
		return largest;
	}
	
	function Graph(data){
		var time_bound = MaxMin(data, function(x){return x.time;}),
				mag_bound = MaxMin(data, function(x){return x.mag;});
		
		ctx.save();
		ctx.translate(100, 100);
		ctx.scale((width-200)/width, (height-200)/height);
		
		ctx.fillStyle = 'rgb(255,255,255)';
		ctx.fillRect(0,0,width,height);
		
		ctx.beginPath();
		for(var i=0,point; point=data[i++];){
			var funct = i == 1 ? ctx.moveTo : ctx.lineTo;
			var x = (point.time - time_bound.min) / (time_bound.max - time_bound.min),
					y = (point.mag - mag_bound.min) / (mag_bound.max - mag_bound.min);
			funct.call(ctx, x*width, (1-y)*height);
		}
		ctx.stroke();
		
		// draw peaks
		const peak_threshhold = 0.07;
		const frames_threshhold = 0.005;
		var peaks = FilterPeaks(FindPeaks(data), peak_threshhold),
				freq_frames = FrequencyFrames(peaks, frames_threshhold),
				range = LargestFrame(freq_frames);
		
		for(var i=range.start; i<range.end; i++){
			var peak = peaks[i];
			var x = (peak.time - time_bound.min) / (time_bound.max - time_bound.min),
					y = (peak.mag - mag_bound.min) / (mag_bound.max - mag_bound.min);
			ctx.fillStyle = 'rgb(0,0,200)';
			ctx.fillRect(x*width-5, (1-y)*height-5, 10, 10);
		}
		
		ctx.restore();
		
		ctx.fillStyle = 'rgb(0,0,0)';
		ctx.textAlign = 'right';
		
		ctx.fillText(Math.round(mag_bound.max*1000)/1000, 90, 110);
		ctx.fillText(Math.round(mag_bound.min*1000)/1000, 90, height-100);
		
		ctx.textAlign = 'left';
		ctx.fillText(0, 100, height-80);
		
		ctx.textAlign = 'right';
		ctx.fillText(time_bound.max-time_bound.min, width-100, height-80);
		
	}
	
		//
	// window.addEventListener('load', Init);
	//
	// function Init(){
	// 	LoadHeader();
	// }
	//
	// function LoadHeader(){
	// 	var identifier = document.getElementById('identifier');
	// 	identifier.removeAttribute('id');
	//
	// 	var register = document.getElementById('register');
	// 	register.removeAttribute('id');
	//
	// 	Device.addEventListener('register', function(){
	// 		identifier.innerHTML = Device.identifier();
	// 		classie.add(register.parentElement, 'registered');
	// 	})
	//
	// 	register.addEventListener('click', RegisterDevice);
	// }
	//
	// function RegisterDevice(){
	// 	Device.addEventListener('register', OnDeviceRegister);
	// 	Device.register('Master Controller');
	// }
	// function OnDeviceRegister(){
	// 	Device.addEventListener('message', OnMessage);
	// }
	//
	// function OnMessage(event){
	// 	var source = event.source,
	// 			method = event.method,
	// 			data = event.data;
	// 	if(method == 'mobile.acceleration') ProcessAcceleration(data);
	// }
	//
	// function ProcessAcceleration(event){
	// 	var data = event.data,
	// 			nickname = event.source,
	// 			time = new Date(event.timestamp);
	// 	console.info('Acceleration Received from \''+nickname+'\'');
	// 	AddDataFrame(data, nickname, time);
	// }
	//
	// function FormatTime(time){
	// 	var hours = time.getHours() % 12;
	// 	if(hours == 0) hours = 12;
	// 	var minutes = time.getMinutes()+'';
	// 	if(minutes.length == 1) minutes = '0'+minutes;
	// 	var after = time.getHours() >= 12 ? 'PM' : 'AM';
	// 	return hours+':'+minutes+' '+after;
	// }
	//
	// function AddDataFrame(data, nickname, time){
	// 	var frame = document.createElement('div');
	// 	classie.add(frame, 'data');
	//
	// 	var title = document.createElement('h1');
	// 	title.appendChild(document.createTextNode(nickname));
	// 	frame.appendChild(title);
	//
	// 	var label = document.createElement('label');
	// 	label.innerHTML = FormatTime(time);
	// 	title.appendChild(label);
	//
	// 	var canvas = document.createElement('canvas');
	// 	frame.appendChild(canvas);
	//
	// 	document.body.appendChild(frame);
	//
	// 	RenderCanvas(canvas, data);
	// }
	//
	// function MaxMin(list, getter){
	// 	if(typeof getter != 'function') getter = function(x){return x;};
	// 	var max = getter(list[0]), min = getter(list[0]);
	// 	for(var i=1; i<list.length; i++){
	// 		var value = getter(list[i]);
	// 		if(value < min) min = value;
	// 		if(value > max) max = value;
	// 	}
	// 	return {max:max, min:min};
	// }
	// function RenderCanvas(canvas, data){
	// 	var width, height;
	// 	width = canvas.width = canvas.offsetWidth;
	// 	height = canvas.height = canvas.offsetHeight;
	//
	// 	console.log(JSON.stringify(data))
	//
	// 	var ctx = canvas.getContext('2d');
	//
	// 	var starttime = data[0].time,
	// 			endtime = data[data.length-1].time;
	//
	// 	var maxmin = MaxMin(data, function(elem){return elem.mag;});
	//
	// 	function ScaleValue(y){
	// 		var max = maxmin.max,
	// 				min = maxmin.min;
	// 		return (y-min)/(max-min)*height;
	// 	}
	// 	function Render(list, tag){
	// 		ctx.beginPath();
	// 		ctx.moveTo(0, height-ScaleValue(data[0][tag]));
	// 		for(var i=1; i<list.length; i++)
	// 			ctx.lineTo((list[i].time-starttime)/(endtime-starttime)*width, height-ScaleValue(data[i][tag]));
	// 		ctx.stroke();
	// 	}
	//
	// 	ctx.strokeStyle = 'rgb(0,0,255)';
	// 	Render(data, 'mag');
	// }
	
})();
</script>
</body>
</html>
